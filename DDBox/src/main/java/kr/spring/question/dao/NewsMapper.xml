<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.spring.question.dao.NewsMapper">
	<!-- 공지/뉴스 글 등록 -->
	<insert id="insertNews" parameterType="newsVO">
		INSERT INTO news(
			news_num,
			mem_num,
			news_category,
			news_title,
			news_content)
		VALUES (
			news_seq.nextval,
			#{mem_num},
			#{news_category},
			#{news_title},
			#{news_content})
	</insert>
	
	<!-- 검색기능 -->
	<sql id="newsSearch">
		<where>
		<if test="news_category != null and news_category != ''">
			news_category = #{news_category} 
		</if>
		<if test="(news_category != null and news_category != '') and (keyword != null and keyword != '')">
			AND (news_title LIKE '%' || #{keyword} || '%' OR
			news_content LIKE '%' || #{keyword} || '%')
		</if>
		<if test="(news_category == null or news_category == '') and (keyword != null and keyword != '')">
			news_title LIKE '%' || #{keyword} || '%' OR
			news_content LIKE '%' || #{keyword} || '%'
		</if>
		</where>
	</sql>
	
	<!-- 정렬기능 -->
	<sql id="newsOrder">
		<if test="order == 1">
			ORDER BY news_num DESC
		</if>
		<if test="order == 2">
			ORDER BY news_hit DESC
		</if>
		<if test="order == 3">
			ORDER BY news_regdate DESC
		</if>
	</sql>
	
	<!-- 총 개수/ 검색 개수 -->
	<select id="selectRowCount" parameterType="map" resultType="integer">
		SELECT
			COUNT(*)
		FROM news JOIN member USING (mem_num)
		<include refid="newsSearch"></include>
	</select>
	
	<!-- 뉴스/공지 전체 목록/ 검색 목록 -->
	<select id="selectList" parameterType="map" resultType="newsVO">
		SELECT
		  *
		FROM (SELECT
				a.*,
				rownum rnum
			  FROM (SELECT
					  news_num,
					  news_category,
					  <![CDATA[
					  REPLACE(REPLACE(news_title,'<','&lt;'),'>','&gt;') news_title,
					  ]]>
					  news_hit
				    FROM news
				    JOIN member USING(mem_num)
					<include refid="newsSearch"></include>
					<include refid="newsOrder"></include>)a)
		<![CDATA[
		WHERE rnum >= #{start} AND rnum <= #{end}
		]]>
	</select>	
	
	<!-- 뉴스/공지 글상세 -->
	<select id="selectNews" parameterType="integer">
		SELECT
			*
		FROM news
		JOIN member USING(mem_num)
		LEFT OUTER JOIN member_detail USING(mem_num)
		WHERE news_num=#{news_num}
	</select>
	
	<!-- 뉴스/공지 글수정 -->
	<update id="updateNews" parameterType="newsVO">
		UPDATE news SET
			news_title=#{news_title},
			news_category=#{news_category},
			news_content=#{news_content}
		WHERE news_num=#{news_num}
	</update>	
	
</mapper>